{% extends "layout.html" %}

{% block title %}
    Build Lineup
{% endblock %}

{% block main %}

<div class="container">
    <div class="pageheader">
        <h4>Now let's add your players.</h4>
        <br>
        <p class="lead"><em>When you've added the required quantity for each positon, the box will turn<img id="samplecolor" src="static/images/samplecolor.jpg" alt="successcolor"></em></p>
        <p class="lead"><em>When all required quantities are added, an <button class="btn btn-primary">Optimize Lineup</button> button will appear. Click on it to proceed!</em></p>
    </div>
    <br>
    <table class="table">
        <div class="alert alert-secondary" role="alert" id="alertMessage">{{message}}</div>
        <tr>
        {% for item in roster_details %}
            <th>{{item}}</th>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            <td id="set{{item}}">{{roster_details[item]}}</td>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            {% if item == "Type" %}
            <td>Inputted:</td>
            {% else %}
            <td id="{{item}}">0</td>
            {% endif %}
        {% endfor %}
        </tr>
    </table>
    <!--if user reaches page via nav-bar-->
    {% if success_banner %}
    <div id ="nav_bar_success" class="alert alert-success" role="alert" style="text-align:center; display:block">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    {% endif %}
    <div id ="success" class="alert alert-success" role="alert" style="text-align:center; display:none">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    <form action="/displaydetails" method="post" autocomplete="off">
        <div class="form-group">
            <label>Start typing a player name below:</label>
            <input type="text" name="playerlookup" list="players" id="player" autofocus>
                <datalist id="players">
                </datalist>
        </div>
    </form>
    <div class="row justify-content-center">
        <button class="btn btn-primary" id="addplayer">Add Player</button>
    </div>
        <br>
        <p class="text-danger" id='invalid_input'>Duplicate or invalid selection. Please choose another player.</p>
    <div>
        <ul>
        </ul>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th colspan="3" class="display-4"><button style="float:left; margin-top: 15px" class="btn btn-primary" id="save">Save Lineup</button>{{roster_name}}
                <button style="float:right; margin-top: 15px" class="btn btn-primary" id="clear_lineup">Clear Lineup</button></th>
            </tr>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Position</th>
                <th>FFN ID</th>
            </tr>
        </thead>
        <tbody id="inserthere">
        </tbody>
    </table>
    <p hidden id="rosterName">{{roster_name}}</p>
    <form hidden class="form-group" type="submit" method="post" action="/save" id="saveLineup">
        <input type="hidden" id="savedLineup" name="savedLineup">
    </form>
</div>
    <script>
        //list for storing selected players
        let playerList = [];

        //players in current roster (updated during GET request during page load)
        let currentPlayers = [];

        //roster Name
        let rosterName = getId("rosterName").innerHTML;

        //get players current stored in roster
        $.get('/loadPlayers?rosterName=' + rosterName, function(data) {
            currentPlayers = data;
            data.forEach(player => {
                playerList.push(player);
                counterChange(player.playerPosition, 'add', true);
                getId('inserthere').innerHTML += `<tr><td>${player.playerName}</td><td class="playerPosition">${player.playerPosition}</td><td>${player.playerTeam}</td>
                <td class="playerId">${player.playerId}</td><td><button class="remove" class="btn btn-primary">Remove</button></td></tr>`;
            });
        });

        window.onload = () => {
            getId('alertMessage').innerHTML !== '' ? getId('alertMessage').style.visibility = 'visible' : '' ;
        }

        let input = document.querySelector('input');
        input.onkeyup = () => {
            let matchList = [];
            if (input.value) {
                for (player of players) {
                    if (player.displayName.toLowerCase().startsWith(input.value.toLowerCase())) {
                        matchList.push(`<option> ${player.displayName}, ${player.position}, ${player.team}, ${player.playerId} </option>`);
                    }
                    if (matchList.length > 5) {
                        break;
                    }
                }
                document.querySelector('datalist').innerHTML = matchList.toString();
            }
        };

        let addplayer = document.querySelector('#addplayer');
        addplayer.onclick = e => {

            selectionDetails = input.value.split(', ');
            selectedPlayer = {};

            player_details.forEach((detail, index) => selectedPlayer[detail] = selectionDetails[index]);

            if (!players.some(player => player.playerId === selectedPlayer.playerId) || playerList.some(player => player.playerId === selectedPlayer.playerId)
            || playerList.length >= numberConv(getId('setRostered'))) {
                e.preventDefault();
                invalid_input_message('Duplicate/invalid selection or maximum number of players added');
                return false;
            } else {

                //add ID to selected players list
                playerList.push(selectedPlayer);

                //add to selected players table
                getId('inserthere').innerHTML += `<tr><td>${selectedPlayer.playerName}</td><td class="playerPosition">${selectedPlayer.playerPosition}</td><td>${selectedPlayer.playerTeam}</td>
                <td class="playerId">${selectedPlayer.playerId}</td><td><button class="remove" class="btn btn-primary">Remove</button></td></tr>`;

                //flash add colors in position quantities table
                counterChange(selectedPlayer.playerPosition, 'add');

                //clear player searchbar & refocus search bar
                getId('player').value = '';
                getId('player').focus();
            }
        };

        let clearLineup = getId('clear_lineup');
        clearLineup.onclick = () => {
            playerList = [];
            getId("inserthere").innerHTML = '';
            roster_details.forEach(detail => {
                //only need to reset inputted roster position quantities, not type of roster(ppr or standard)
                if (detail !== 'Type') {
                    getId(detail).innerHTML = 0;
                    addColor(detail);
                }
            });
        };


        $(document).on("click", "button.remove", function() {
            let positionRemove = $(this).closest("tr").find(".playerPosition").text();
            let playerIdRemove = $(this).closest("tr").find(".playerId").text();

            let removeIndex = playerList.map(player => player.playerId).indexOf(playerIdRemove);
            playerList.splice(removeIndex, 1);

            //update counter
            counterChange(positionRemove, 'remove');

            // remove row from player table
            $(this).closest("tr").remove();
        });

        getId('save').onclick = e => {
                dataToSend = {};
                dataToSend["rosterName"] = rosterName;
                dataToSend["playersToAdd"] = playerList.filter(player => !currentPlayers.includes(player))
                dataToSend["playersToDelete"] = currentPlayers.filter(player => !playerList.includes(player));
                getId("savedLineup").setAttribute('value', JSON.stringify(dataToSend));
                document.getElementsByTagName('form')[1].submit();
        };

    </script>

{% endblock %}
