{% extends "layout.html" %}

{% block title %}
    Build Lineup
{% endblock %}

{% block main %}

<div class="container">
    <div class="pageheader">
        <h4>Now let's add your players.</h4>
        <br>
        <p class="lead"><em>When you've added the required quantity for each positon, the box will turn<img id="samplecolor" src="static/images/samplecolor.jpg" alt="successcolor"></em></p>
        <p class="lead"><em>When all required quantities are added, an <button class="btn btn-primary">Optimize Lineup</button> button will appear. Click on it to proceed!</em></p>
    </div>
    <br>
    <table class="table">
        <tr>
        {% for item in roster_details %}
            <th>{{item}}</th>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            <td id="set{{item}}">{{roster_details[item]}}</td>
        {% endfor %}
        </tr>
        <tr id="counter_items">
            <td>Inputted:</td>
            {% for item in counter %}
            <td id={{item}}>{{counter[item]}}</td>
            {% endfor %}
        </tr>
    </table>
    <!--if user reaches page via nav-bar-->
    {% if success_banner %}
    <div id ="nav_bar_success" class="alert alert-success" role="alert" style="text-align:center; display:block">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    {% endif %}
    <div id ="success" class="alert alert-success" role="alert" style="text-align:center; display:none">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    <form action="/displaydetails" method="post" autocomplete="off">
        <div class="form-group">
            <label>Start typing a player name below:</label>
            <input type="text" name="playerlookup" list="players" id="player" autofocus>
                <datalist id="players">
                </datalist>
        </div>
    </form>
    <div class="row justify-content-center">
        <button class="btn btn-primary" id="addplayer">Add Player</button>
    </div>
        <br>
        <p class="text-danger" id='invalid_input'>Duplicate or invalid selection. Please choose another player.</p>
    <table class="table">
        <thead>
            <tr>
                <th colspan="3" class="display-4">Your Team</th><th><button style="align:right" class="btn btn-primary" id="clear_lineup">Clear Lineup</button></th>
            </tr>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Position</th>
            </tr>
        </thead>
        <tbody id="inserthere">
            {% if Final_Roster %}
            {% for player in Final_Roster %}
            <tr >
                <td>{{player["name"]}}</td><td>{{player["team"]}}</td><td>{{player["position"]}}</td><td><button class="remove" class="btn btn-primary">Remove</button></td>
            </tr>
            {% endfor %}
            {% endif %}
        </tbody>
    </table>
    <form hidden class="form-group" type="submit" method="post" action="/createlineup" id="submitroster">
        <input type="hidden" id="sendlineup" name="sendlineup">
    </form>
</div>
    <script>
        /*list of flex positions & roster_details for general verification*/
        let flex_positions = ["RB", "WR", "TE"];
        let roster_details = ["Rostered", "Starting", "Bench", "QB", "RB", "WR", "TE", "FLEX", "DEF", "K"];

        /*flash different color for <td> whose values are being changed*/
        function flash_add_color(detail) {
            document.getElementById(detail).style.backgroundColor = "#d3d3d3";
            setTimeout( function() {
                document.getElementById(detail).style.backgroundColor = "";
                }, 500);
        }

        /*change <td> color to green if <td> value equals required roster quantity*/
        function final_color(detail) {
            document.getElementById(detail).style.backgroundColor = "#d4edda";
        }

        /*retrieve set roster parameter from <td>'s with user inputted levels from step 1*/
        function set_value(detail) {
            return $("#set"+detail).html();
        }

        function display_banner(display_proceed_button) {
            if  (display_proceed_button) {
                document.getElementById("success").style.display = "block";
            }
            else if (document.getElementById("nav_bar_success") && document.getElementById("nav_bar_success").style.display == "block") {
                document.getElementById("nav_bar_success").style.display = "none";
            }
            else {
                document.getElementById("success").style.display = "none";
            }
        }

        function invalid_input_message(display_message) {
            document.getElementById("invalid_input").innerHTML = display_message;
            document.getElementById("invalid_input").style.visibility = "visible";
            setTimeout(function() {
                document.getElementById("invalid_input").style.visibility = "hidden";
            }, 3000);
        }

        /*end of variable/function definitions, start of page scripts*/
        /*if page reloaded from nav-bar, check inputted roster quantities against required quantities*/
        for (var i = 0; i < roster_details.length; i++) {
            if ($("#"+roster_details[i]).html() == set_value(roster_details[i])) {
                final_color(roster_details[i]);
            }
        }

        let input = document.querySelector('input');
        input.onkeyup = function() {
            let html = '';
            if (input.value) {
                for (player of players) {
                    if (player.displayName.toLowerCase().startsWith(input.value.toLowerCase())) {
                        html += '<option>' + player.displayName + ' ' + player.team + ' ' + player.position + '</option>';
                    }
                }
                document.querySelector('datalist').innerHTML = html;
            }
        };

        /*create drop-down of all available players
        let input = document.querySelector('input');
        input.onkeyup = function() {
            $.get('/search?q=' + input.value, function(data) {
                let html = '';
                for (player of data) {
                    html += '<option>' + player + '</option>';
                }
                document.querySelector('datalist').innerHTML = html;
            });
        };*/

        let addplayer = document.querySelector("#addplayer");
        addplayer.onclick = function(e) {
            /*prevent too many players from being added*/
            if ($("#Rostered").html() == set_value("Rostered")) {
                e.preventDefault();
                invalid_input_message('Roster filled! Please remove a player before making another selection.');
                return false;
            }
            $.get("/addplayer?q=" + input.value, function(data) {
                /*prevent invalid entry*/
                if (data == false) {
                    e.preventDefault();
                    invalid_input_message('Duplicate or invalid selection. Please choose another player.');
                    return false;
                }
                /* add player after input verified*/
                var name = data[0][0];
                var team = data[0][1];
                var position = data[0][2];
                var current_count = data[1];
                var display_proceed_button = data[2];

                /*add row for added player*/
                document.querySelector('#inserthere').innerHTML += '<tr>' + '<td>' + name + '</td>' + '<td>' + team +'</td>' +'<td>' + position +
                '</td>' + '<td>' + '<button class="remove" class="btn btn-primary">Remove</button>' + '</td>' + '</tr>';

                for ([pos, count] of Object.entries(current_count)) {
                    document.getElementById(pos).innerHTML = count;
                    /*if position count equals required quantity, change <td> color to green*/
                    if (current_count[pos] == set_value(pos)) {
                        final_color(pos);
                    }
                }
                /*check if need to add to rostered <td>*/
                if (current_count["Rostered"] < set_value("Rostered")) {
                    flash_add_color("Rostered");
                }

                /* check if need flash add color to bench or starting & add to rostered <td> if less than required quantity */
                if (current_count["Rostered"] > set_value("Starting") && current_count["Rostered"] < set_value("Rostered")) {
                    flash_add_color("Bench");
                }
                else if (current_count["Starting"] < set_value("Starting")) {
                    flash_add_color("Starting");
                }

                /*add to flex or normal position */
                if (current_count["FLEX"] > 0 && current_count["FLEX"] < set_value("FLEX") && flex_positions.includes(position)) {
                    flash_add_color("FLEX");
                }
                else if (current_count[position] < set_value(position)) {
                    flash_add_color(position);
                }
                display_banner(display_proceed_button);
            });
            input.value = '';
            document.getElementById("players").innerHTML = "";
        };

        $(document).on("click", "#clear_lineup", function(data) {
            $.get('/clear_lineup', function(data) {
                var display_proceed_button = data[1];
                document.querySelector('#inserthere').innerHTML = "";
                for ([pos, count] of Object.entries(data[0])) {
                    document.getElementById(pos).innerHTML = count;
                    if ($("#" + pos).html() == set_value(pos)) {
                        final_color(pos);
                    }
                    else {
                        flash_add_color(pos);
                    }
                }
                display_banner(display_proceed_button);
            });
        });

        $(document).on("click", "button.remove", function() {
            var name_to_remove = ($(this).closest("tr").text().replace("Remove", "").trim());
            $.get("/removeplayer?q=" + name_to_remove, function(data) {
                var current_count = data[0];
                var display_proceed_button = data[1];
                console.log(display_proceed_button);
                for ([pos, count] of Object.entries(current_count)) {
                    if (current_count[pos] == set_value(pos)) {
                        final_color(pos);
                    }
                    else {
                        flash_add_color(pos);
                    }
                    document.getElementById(pos).innerHTML = count;
                }
                display_banner(display_proceed_button);
            });
            $(this).closest("tr").remove();
        });

        $(document).on("click", "#submitlineup", function() {
            document.getElementById("submitroster").submit();
        });

    </script>

{% endblock %}