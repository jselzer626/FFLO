{% extends "layout.html" %}

{% block title %}
    Build Lineup
{% endblock %}

{% block main %}

<div class="container">
    <div class="pageheader">
        <h4>Now let's add your players.</h4>
        <br>
        <p class="lead"><em>When you've added the required quantity for each positon, the box will turn<img id="samplecolor" src="static/images/samplecolor.jpg" alt="successcolor"></em></p>
        <p class="lead"><em>When all required quantities are added, an <button class="btn btn-primary">Optimize Lineup</button> button will appear. Click on it to proceed!</em></p>
    </div>
    <br>
    <table class="table">
        <tr>
        {% for item in roster_details %}
            <th>{{item}}</th>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            <td id="set{{item}}">{{roster_details[item]}}</td>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            {% if item == "Type" %}
            <td>Inputted:</td>
            {% else %}
            <td id="{{item}}">0</td>
            {% endif %}
        {% endfor %}
        </tr>
    </table>
    <!--if user reaches page via nav-bar-->
    {% if success_banner %}
    <div id ="nav_bar_success" class="alert alert-success" role="alert" style="text-align:center; display:block">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    {% endif %}
    <div id ="success" class="alert alert-success" role="alert" style="text-align:center; display:none">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    <form action="/displaydetails" method="post" autocomplete="off">
        <div class="form-group">
            <label>Start typing a player name below:</label>
            <input type="text" name="playerlookup" list="players" id="player" autofocus>
                <datalist id="players">
                </datalist>
        </div>
    </form>
    <div class="row justify-content-center">
        <button class="btn btn-primary" id="addplayer">Add Player</button>
    </div>
        <br>
        <p class="text-danger" id='invalid_input'>Duplicate or invalid selection. Please choose another player.</p>
    <div>
        <ul>
        </ul>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th colspan="3" class="display-4">Your Team</th><th><button style="align:right" class="btn btn-primary" id="clear_lineup">Clear Lineup</button></th>
            </tr>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Position</th>
                <th>FFN ID</th>
            </tr>
        </thead>
        <tbody id="inserthere">
        </tbody>
    </table>
    <form hidden class="form-group" type="submit" method="post" action="/createlineup" id="submitroster">
        <input type="hidden" id="sendlineup" name="sendlineup">
    </form>
</div>
    <script>
        /*list of flex positions & roster_details for general verification*/
        let flex_positions = ["RB", "WR", "TE"];
        let roster_details = ["Rostered", "Starting", "Bench", "QB", "RB", "WR", "TE", "FLEX", "DEF", "K"];
        let playerList = [];

        //factor out so many document.getElementById calls
        getId = Id => {
            return document.getElementById(Id);
        }

        numberConv = elem => {
            return parseInt(elem.innerHTML);
        }

        /*flash different color for <td> whose values are being changed*/
        function flash_add_color(detail) {
            document.getElementById(detail).style.backgroundColor = "#d3d3d3";
            setTimeout( function() {
                document.getElementById(detail).style.backgroundColor = "";
                }, 500);
        }

        /*change <td> color to green if <td> value equals required roster quantity*/
        function final_color(detail) {
            document.getElementById(detail).style.backgroundColor = "#d4edda";
        }

        /*retrieve set roster parameter from <td>'s with user inputted levels from step 1*/
        function set_value(detail) {
            return $("#set"+detail).html();
        }

        function display_banner(display_proceed_button) {
            if  (display_proceed_button) {
                document.getElementById("success").style.display = "block";
            }
            else if (document.getElementById("nav_bar_success") && document.getElementById("nav_bar_success").style.display == "block") {
                document.getElementById("nav_bar_success").style.display = "none";
            }
            else {
                document.getElementById("success").style.display = "none";
            }
        }

        function invalid_input_message(display_message) {
            document.getElementById("invalid_input").innerHTML = display_message;
            document.getElementById("invalid_input").style.visibility = "visible";
            setTimeout(function() {
                document.getElementById("invalid_input").style.visibility = "hidden";
            }, 3000);
        }

        let input = document.querySelector('input');
        input.onkeyup = function() {
            let html = '';
            if (input.value) {
                for (player of players) {
                    if (player.displayName.toLowerCase().startsWith(input.value.toLowerCase())) {
                        //why can't I call join here
                        html += '<option>' + player.displayName + ' , ' + player.position + ' , ' + player.team + ' , ' + player.playerId + '</option>';
                    }
                }
                document.querySelector('datalist').innerHTML = html;
            }
        };

        let addplayer = document.querySelector('#addplayer');
        addplayer.onclick = function(e) {

            selectionDetails = input.value.split(' , ');

            if (!players.some(player => player.playerId === selectionDetails[3]) || playerList.includes(selectionDetails[3]) || playerList.length >= document.getElementById("setRostered").value) {
                e.preventDefault();
                invalid_input_message('Duplicate/invalid selection or maximum number of players added');
                return false;
            } else {

                playerList.push(selectionDetails[3]);

                document.querySelector('#inserthere').innerHTML += '<tr>' + '<td>' + selectionDetails[0] + '</td>' + '<td>' + selectionDetails[1] +'</td>' +'<td>' + selectionDetails[2] +
                '</td>' + '<td>' + selectionDetails[3] + '</td>' + '<td>' + '<button class="remove" class="btn btn-primary">Remove</button>' + '</td>' + '</tr>';

                getId('Rostered').innerHTML = numberConv(getId('Rostered')) + 1;

                numberConv(getId('Starting')) >= numberConv(getId('setStarting')) ? getId("Bench").innerHTML = numberConv(getId('Bench')) + 1 :
                getId("Starting").innerHTML = numberConv(getId('Starting')) + 1;

                numberConv(getId(selectionDetails[1])) >= numberConv(getId("set" + selectionDetails[1])) && numberConv(getId('FLEX')) < numberConv(getId('setFLEX')) &&
                flex_positions.includes(selectionDetails[1]) ? getId("FLEX").innerHTML = numberConv(getId('FLEX')) + 1 : '' ;

                numberConv(getId(selectionDetails[1])) < numberConv(getId("set" + selectionDetails[1])) ?
                getId(selectionDetails[1]).innerHTML = numberConv(getId(selectionDetails[1])) + 1 : '' ;

            }
        };

        let clearLineup = document.getElementById('clear_lineup');
        clearLineup.onclick = () => {
            document.getElementById("inserthere").innerHTML = '';
        };


        $(document).on("click", "button.remove", function() {
            $(this).closest("tr").remove();
        });

        $(document).on("click", "#submitlineup", function() {
            document.getElementById("submitroster").submit();
        });

    </script>

{% endblock %}