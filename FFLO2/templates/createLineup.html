{% extends "layout.html" %}

{% block title %}
    Build Lineup
{% endblock %}

{% block main %}

<div class="container">
    <div class="pageheader">
        <h4>Now let's add your players.</h4>
        <br>
        <p class="lead"><em>When you've added the required quantity for each positon, the box will turn<img id="samplecolor" src="static/images/samplecolor.jpg" alt="successcolor"></em></p>
        <p class="lead"><em>When all required quantities are added, an <button class="btn btn-primary">Optimize Lineup</button> button will appear. Click on it to proceed!</em></p>
    </div>
    <br>
    <table class="table">
        <tr>
        {% for item in roster_details %}
            <th>{{item}}</th>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            <td id="set{{item}}">{{roster_details[item]}}</td>
        {% endfor %}
        </tr>
        <tr>
        {% for item in roster_details %}
            {% if item == "Type" %}
            <td>Inputted:</td>
            {% else %}
            <td id="{{item}}">0</td>
            {% endif %}
        {% endfor %}
        </tr>
    </table>
    <!--if user reaches page via nav-bar-->
    {% if success_banner %}
    <div id ="nav_bar_success" class="alert alert-success" role="alert" style="text-align:center; display:block">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    {% endif %}
    <div id ="success" class="alert alert-success" role="alert" style="text-align:center; display:none">All required players added!
    <br>
    <button class="btn btn-primary" id="submitlineup" name="submitlineup">Optimize Lineup</button>
    </div>
    <form action="/displaydetails" method="post" autocomplete="off">
        <div class="form-group">
            <label>Start typing a player name below:</label>
            <input type="text" name="playerlookup" list="players" id="player" autofocus>
                <datalist id="players">
                </datalist>
        </div>
    </form>
    <div class="row justify-content-center">
        <button class="btn btn-primary" id="addplayer">Add Player</button>
    </div>
        <br>
        <p class="text-danger" id='invalid_input'>Duplicate or invalid selection. Please choose another player.</p>
    <div>
        <ul>
        </ul>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th colspan="3" class="display-4">{{roster_name}}</th><th><button style="align:right" class="btn btn-primary" id="clear_lineup">Clear Lineup</button></th>
            </tr>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Position</th>
                <th>FFN ID</th>
            </tr>
        </thead>
        <tbody id="inserthere">
        </tbody>
    </table>
    <form hidden class="form-group" type="submit" method="post" action="/createlineup" id="submitroster">
        <input type="hidden" id="sendlineup" name="sendlineup">
    </form>
</div>
    <script>

        //list for storing selected players
        let playerList = [];

        //change <td> color to green if <td> value equals required roster quantity
        addColor = detail => {
            //check if final color needed
            if (numberConv(getId(detail)) === numberConv(getId('set' + detail))) {
                getId(detail).style.backgroundColor = "#d4edda";
            } else {
                //flash gray if else
                getId(detail).style.backgroundColor = "#d3d3d3";
                setTimeout( function() {
                    getId(detail).style.backgroundColor = "";
                }, 500);
            }
        };

        let input = document.querySelector('input');
        input.onkeyup = function() {
            let html = '';
            if (input.value) {
                for (player of players) {
                    if (player.displayName.toLowerCase().startsWith(input.value.toLowerCase())) {
                        //why can't I call join here
                        html += '<option>' + player.displayName + ' , ' + player.position + ' , ' + player.team + ' , ' + player.playerId + '</option>';
                    }
                }
                document.querySelector('datalist').innerHTML = html;
            }
        };

        let addplayer = document.querySelector('#addplayer');
        addplayer.onclick = e => {

            selectionDetails = input.value.split(' , ');

            if (!players.some(player => player.playerId === selectionDetails[3]) || playerList.includes(selectionDetails[3])
            || playerList.length >= numberConv(getId('setRostered'))) {
                e.preventDefault();
                invalid_input_message('Duplicate/invalid selection or maximum number of players added');
                return false;
            } else {

                //add ID to selected players list
                playerList.push(selectionDetails[3]);

                //add to selected players table
                getId('inserthere').innerHTML += `<tr><td>${selectionDetails[0]}</td><td class="playerPosition">${selectionDetails[1]}</td><td>${selectionDetails[2]}</td>
                <td class="playerId">${selectionDetails[3]}</td><td><button class="remove" class="btn btn-primary">Remove</button></td></tr>`;

                //flash add colors in position quantities table
                counterChange(selectionDetails[1], 'add');

                //clear player searchbar
                //TODO
            }
        };

        let clearLineup = getId('clear_lineup');
        clearLineup.onclick = () => {
            playerList = [];
            getId("inserthere").innerHTML = '';
            roster_details.forEach(detail => {
                getId(detail).innerHTML = 0;
                addColor(detail);
            });
        };


        $(document).on("click", "button.remove", function() {
            var position = $(this).closest("tr").find(".playerPosition").text();
            var playerIdRemove = $(this).closest("tr").find(".playerId").text();

            //remove from player array
            playerList.splice(playerList.indexOf(playerIdRemove), 1);

            //update counter
            counterChange(position, 'remove');

            // remove row from player table
            $(this).closest("tr").remove();


        });

        $(document).on("click", "#submitlineup", function() {
            document.getElementById("submitroster").submit();
        });

    </script>

{% endblock %}